# 卡尔曼滤波（KF）

-   **一句话总结：**

  **卡尔曼滤波是一种“边测量边修正”的算法，用来从有噪声的数据中估计出更准确的结果。**

- 符号：

  | 符号            | 含义                                            |
  | --------------- | ----------------------------------------------- |
  | $x_k$           | 系统在时刻 $k$ 的真实状态（我们要估计的）       |
  | $\hat{x}_k^{-}$ | 时刻 $k$ 的**预测值**，也叫先验估计值（未更新） |
  | $\hat{x}_k$     | 时刻 $k$ 的**估计值**，也叫后验估计值（更新后） |
  | $z_k$           | 时刻 $k$ 的测量值（带噪声）                     |
  | $u_k$           | 控制量（可选，例如速度）                        |
  | $w_k$           | 过程噪声，服从高斯分布                          |
  | $v_k$           | 测量噪声，服从高斯分布                          |
  | $F$             | 状态转移系数（比如1表示匀速）                   |
  | $B$             | 控制输入系数                                    |
  | $H$             | 观测矩阵（比如直接观测位置就是1）               |
  | $Q$             | 过程噪声协方差（表示预测的不确定性）            |
  | $R$             | 测量噪声协方差（表示测量的不确定性）            |
  | $P_k^{-}$       | 预测误差协方差（先验估计值的不确定性）          |
  | $P_k$           | 更新后的误差协方差                              |
  | $K_k$           | 卡尔曼增益（决定信谁多一点）                    |

- 适用系统：线性高斯系统

  - 线性：比如 $y = kx+b$, $z = ax+by$ ，同时满足叠加性和齐次性的系统
  - 高斯：噪声满足正态分布

- 状态空间表达式
  - **状态方程**： $x_k = Fx_{k-1} + Bu_k + w_k$ 
  - **观测方程**： $ z_k = Hx_k + v_k$ 

- 参数分析
  - $w_k \in N(0, Q_k)$ ；$v_k \in N(0, R_k)$ 
  - 其中， $Q_k, R_k$ 为噪声方差 

- 超参数
  - $Q, R$ 

- 卡尔曼滤波公式

  - 实现过程：使用上一次的最优结果预测当前值（先验估计），同时使用观测值修正当前值，得到最优结果

  - 预测阶段：

    1. 先验估计 $\widehat{x}_t^{-}$ ：

    $$
    \widehat{x}_t^{-} = F\widehat{x}_{t-1} + Bu_{t-1} + w_t
    $$
    ​	$u_{t-1}$ 是 $t-1$ 时刻的控制量

    2. 先验估计协方差 $P_t^{-}$ （$P_t^{-} = cov(\widehat{x}_{t}^{-}, \widehat{x}_{t}^{-})$）

    $$
    P_t^- = FP_{t-1}F^T + Q
    $$
    ​	$Q$ 为过程噪声 $w_t$ 的协方差

  - 更新阶段

    1. 更新卡尔曼增益

    $$
    K_t = \frac{P_t^{-}H^T}{H P_t^{-}H^T + R}
    $$

    ​	$R$ 为观测噪声 $v_t$ 的协方差

    2. 状态更新**（最终滤波结果）** 

    $$
    \widehat{x}_{t} = \widehat{x}_{t}^{-} + K_t(z_t - H\widehat{x}_{t}^{-})
    $$

    3. 更新后的后验估计协方差

    $$
    P_t = (I - K_tH)P^{-}_t
    $$
    $I$ 是单位阵

- 公式理解

  - 一维的情况下，$H$ （观测矩阵）和 $F$ （状态转移矩阵）都为1

    带入化简得
    $$
    K = \frac{P_{t-1} + Q}{P_{t-1} + Q + R}
    $$
    

​		回顾：$P$ 为预测噪声协方差，会不断迭代；$Q$ 为过程噪声协方差； $R$ 为测量噪声协方差

​		所以， **$K$ 就是对测量值的信任度，越大对测量值越信任，越小对预测值越信任** 

- $P_0$ 与 $\hat{x}_0$ 的取值
  - $\hat{x}_0$ 习惯取 0，$P$ 往小了取，方便收敛（一般取 1，不能取 0）

- 卡尔曼滤波的大概的使用步骤
  1. 选择状态量 $x$ 和观测量 $z$ 
  2. 构建方程
  3. 初始化参数
  4. 带入公式
  5. 调节超参数 $Q$、$R$ 

---

举例：

一个正在烧水的热水壶，里面插了一个温度计。已知热水壶的功率2200w，效率70%；水的质量是1kg，比热容 4200 J / (kg⋅&deg;C)；温度计的测量误差是 $\pm 1$&deg;C ；环境温度 27&deg;C 。试估计烧开水的时间。（理想热水壶，不考虑受热不均匀和散热的情况）

![82ddbcd5-ee55-452e-bd44-7055bb58e6c4](image/82ddbcd5-ee55-452e-bd44-7055bb58e6c4.png)

我们设计一个这样的一维系统：状态 x 为水当前的温度，输出 y 是温度计测量的温度，输入 u 为热水壶的加热功率

建模：

状态转移方程
$$
xk=Fkxk−1+Bkuk+wk
$$




