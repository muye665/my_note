### 符号定义

$I$：惯性张量

$l$：单臂长度（轴距的一半）

$m$：质量

$k_F$：升力系数

$k_M$：反扭矩系数

${W}$：世界坐标系

${B}$：机体坐标系

${}^WR_B$：机体关于世界坐标系的旋转矩阵

${}^WT_B$：机体关于世界坐标系的位姿变换矩阵

$^B\psi, ^B\theta, ^B\phi$：机体角度

$^Br_x,^Br_y,^Br_z$：机体位置

$^WM_s$：合力矩

$^WF_s$：合力

$^BM_i$：电机 i 产生的反力矩

$^BF_i$：电机 i 产生的推力

$w_i$：电机 i 的角速度

$u_i$：电机 i 的转向，桨叶正装，俯视的情况下，逆时针转等于 -1，顺时针转等于1

电机顺序：1:右前, 2:左后, 3:左前, 4:右后

# 动力学模型推导

对于 $t$ 时刻，无人机的位姿为 $r_x,r_y,r_z, \psi, \theta, \phi$ （省略上标$W$）：
$$
{}^WR_B = R_z(\psi)R_y(\theta)R_x(\phi) =  
\begin{bmatrix}  
c_{\theta}c_{\psi} & s_{\phi}s_{\theta}c_{\psi} - c_{\phi}s_{\psi} & s_{\phi}s_{\psi}+c_{\phi}s_{\theta}c_{\psi} \\

c_{\theta}s_{\psi} & s_{\phi}s_{\theta}s_{\psi}+c_{\phi}c_{\psi} & -s_{\phi}c_{\psi}+c_{\phi}s_{\theta}s_{\psi} \\

-s_{\theta} & s_{\phi}c_{\theta} & c_{\phi}c_{\theta}
\end{bmatrix}
\tag{1}
$$
从位移到合力：
$$
^WF_s = 
\begin{bmatrix}  
{}^WF_x  \\
{}^WF_y  \\
{}^WF_z  \\
\end{bmatrix} 
=
m 
\begin{bmatrix}  
\ddot x \\
\ddot y \\
\ddot z \\
\end{bmatrix}

\tag{2}
$$


从 欧拉角速度 $\Theta = \begin{bmatrix} \dot \phi & \dot \theta & \dot \psi \\ \end{bmatrix}^T $ 到机体角速度 $\boldsymbol\omega = \begin{bmatrix} w_x & w_y & w_z \\ \end{bmatrix}^T $ ：（因为欧拉角的角速度的分别的参考坐标系一般不是正交的，所以角速度要变到机体坐标系，即旋转后的坐标系上）
$$
\begin{aligned}  
\begin{bmatrix}  w_x \\  w_y \\  w_z \\ \end{bmatrix}
&=
\begin{bmatrix} \dot \phi \\ 0 \\ 0 \\ \end{bmatrix}
+ 
R_x(\phi)
\begin{bmatrix} 0 \\ \dot \theta \\ 0 \\ \end{bmatrix}
+
R_x(\phi)R_y(\theta)
\begin{bmatrix} 0 \\ 0 \\ \dot \psi \\ \end{bmatrix} \\
\begin{bmatrix} w_x \\  w_y \\ w_z \\ \end{bmatrix}
&=
\begin{bmatrix} 
1 & 0 & -\sin\theta \\ 
0 & \cos\phi & \sin\phi\cos\theta\\ 
0 & -\sin\phi &  \cos\phi\cos\theta\\ 
\end{bmatrix}
\begin{bmatrix} \dot \phi \\ \dot \theta \\ \dot \psi \\ \end{bmatrix}
\end{aligned}
$$
逆变换：
$$
\begin{bmatrix} \dot \phi \\ \dot \theta \\ \dot \psi \\ \end{bmatrix}
=
\begin{bmatrix} 
1 & \sin\phi\tan\theta & \cos\phi\tan\theta \\ 
0 & \cos\phi & -\sin\phi \\ 
0 & \sin\phi/\cos\theta &  \cos\phi/\cos\theta\\ 
\end{bmatrix}
\begin{bmatrix}  w_x \\ w_y \\ w_z \\ \end{bmatrix}
$$
注意：当 $\theta\to \pm 90^\circ(\cos\theta\to0)$ 时，逆变换会失效（万向节死锁 / 奇异），这就是欧拉角的局限。

从机体角度到合力矩： （忽略螺旋桨力矩，只考虑电机力矩）
$$
{}^WM_s = I \cdot\dot {\boldsymbol\omega}  + \boldsymbol\omega \times (I \cdot{\boldsymbol\omega}) \tag3
$$
这里默认机体坐标系与主惯性轴对齐，即 $I$ 为对角矩阵
$$
I =
\begin{bmatrix} 
I_{xx} & 0 & 0 \\
0 & I_{yy} & 0 \\
0 & 0 & I_{zz} \\
\end{bmatrix}
$$
解得
$$
\dot\omega = I^{-1}[{}^WM_s - \omega\times(I\omega)]
$$

$$
\begin{cases}
\dot\omega_x = \frac1{I_{xx}}[\tau_x - (I_{zz} - I_{yy})\omega_y\omega_z] \\
\dot\omega_y = \frac1{I_{yy}}[\tau_y - (I_{xx} - I_{zz})\omega_x\omega_z] \\
\dot\omega_z = \frac1{I_{zz}}[\tau_z - (I_{yy} - I_{xx})\omega_x\omega_y] \\
\end{cases}
$$




>补充：反对称矩阵
>
>令 $\tilde V_1$ 为 $V_1$ 的反对称矩阵，$ V_1 = \begin{bmatrix} x &y&z \end{bmatrix} $  ，那么
>$$
>\tilde V_1 =
>\begin{bmatrix} 
>0 & -x & y \\
>x & 0 & -z \\
>-y & z & 0 \\
>\end{bmatrix}
>$$
>
>
>有定理
>$$
>V_1 \times V_2 \equiv \tilde V_1V_2
>$$
>

电机推力到合力
$$
{}^WF_s = 
\begin{bmatrix}  
0  \\
0  \\
-mg  \\
\end{bmatrix} +
{}^WR_B
\begin{bmatrix}  
0 \\
0 \\
\sum_{i=1}^4{}^BF_i \\
\end{bmatrix}
$$
电机反扭矩到合力矩 （ $M = r \times F$ ，水平面方向上电机的力不相等造成俯仰和横滚的角速度，竖直方向上由电机的反力矩造成偏航的角速度）
$$
{}^WM_s  = 
 \begin{bmatrix}  
\tau_x  \\
\tau_y  \\
\tau_z  \\
\end{bmatrix} = 
\begin{bmatrix}  
-\frac{lF_1}{\sqrt2} & \frac{lF_2}{\sqrt2} & \frac{lF_3}{\sqrt2} & -\frac{lF_4}{\sqrt2} \\
\frac{lF_1}{\sqrt2} & -\frac{lF_2}{\sqrt2} & \frac{lF_3}{\sqrt2} & -\frac{lF_4}{\sqrt2} \\
^{B}M_1 & ^{B}M_2 & -^{B}M_3 & -^{B}M_4  \\
\end{bmatrix}
$$
单个电机的推力：
$$
F_i = k_F w_i^2
$$
单个电机的反扭矩：
$$
M_i = k_Mw_i^2
$$

---

最终得到无人机的动力学方程为：

- 平动：

$$
m 
\begin{bmatrix}  
\ddot x \\
\ddot y \\
\ddot z \\
\end{bmatrix} =
\begin{bmatrix}  
k_F\sum_{i=1}^4w_i^2(s_{\phi}s_{\psi}+c_{\phi}s_{\theta}c_{\psi}) \\
k_F\sum_{i=1}^4w_i^2(-s_{\phi}c_{\psi}+c_{\phi}s_{\theta}s_{\psi}) \\
k_F\sum_{i=1}^4w_i^2 (c_{\phi}c_{\theta}) -mg \\
\end{bmatrix}
$$

- 转动：

$$
I \cdot\dot {\boldsymbol\omega}  + \boldsymbol\omega \times (I \cdot{\boldsymbol\omega}) 

=
\begin{bmatrix}  
-\frac{lk_F}{\sqrt2} & \frac{lk_F}{\sqrt2} & \frac{lk_F}{\sqrt2} & -\frac{lk_F}{\sqrt2} \\
 \frac{lk_F}{\sqrt2} & -\frac{lk_F}{\sqrt2} & \frac{lk_F}{\sqrt2} & -\frac{lk_F}{\sqrt2} \\
u_1 & u_2 & -u_3 & -u_4  \\
\end{bmatrix}
\begin{bmatrix}  
w_1^2  \\
w_2^2  \\
w_3^2  \\
w_4^2  \\
\end{bmatrix}
$$





---

# 设计控制器

## 1. 基础PID控制器

#### 目标：

#### 		$x_{target},\; y_{target},\;z_{target},\; w_{target}$  (Excluding velocity and acceleration)

#### 观测到的状态变量：

​	**$x,\;y,\;z,\;\dot x,\;\dot y,\;\dot z\;$ (from gps, slam, RTK, or MoCap)** 

​	**$w_x,\;w_y,\;w_z\;$ (from imu)** 

​	**$\phi,\;\delta,\;\psi$ (from AHRS)** 

#### 输出：

#### 		$w_i,\;i\in\{1,2,3,4\}$  (motor angular speed)



#### 控制器：

- 位置环 PD

$$
\begin{bmatrix}  
e_x \\
e_y \\
e_z \\
\end{bmatrix}
=
\begin{bmatrix}  
x_{target} \\
y_{target} \\
z_{target} \\
\end{bmatrix}
-
\begin{bmatrix}  
x \\
y \\
z \\
\end{bmatrix}
$$

$$
\begin{bmatrix}  
\dot x_{target} \\
\dot y_{target} \\
\dot z_{target} \\
\end{bmatrix}
= 
k_p
\begin{bmatrix}  
e_x \\
e_y \\
e_z \\
\end{bmatrix}
+ 
k_d
\frac{d}{dt}
\begin{bmatrix}  
e_x \\
e_y \\
e_z \\
\end{bmatrix}
$$

- 速度环 PID 

$$
\begin{bmatrix}  
e_{\dot x} \\
e_{\dot y} \\
e_{\dot z} \\
\end{bmatrix}
=
\begin{bmatrix}  
\dot x_{target} \\
\dot y_{target} \\
\dot z_{target} \\
\end{bmatrix}
-
\begin{bmatrix}  
\dot x \\
\dot y \\
\dot z \\
\end{bmatrix}
$$

$$
\begin{bmatrix}  
\ddot x_{target} \\
\ddot y_{target} \\
\ddot z_{target} \\
\end{bmatrix}
= 
k_p
\begin{bmatrix}  
e_{\dot x} \\
e_{\dot y} \\
e_{\dot z} \\
\end{bmatrix}
+ 
k_i
\int
\begin{bmatrix}  
e_{\dot x} \\
e_{\dot y} \\
e_{\dot z} \\
\end{bmatrix}
dt
+ 
k_d
\frac{d}{dt}
\begin{bmatrix}  
e_{\dot x} \\
e_{\dot y} \\
e_{\dot z} \\
\end{bmatrix}
$$

- 计算目标合推力

​	根据前面的公式
$$
m\ddot z = k_F\sum_{i=1}^4w_i^2 (c_{\phi}c_{\theta}) -mg \\
$$
​	得
$$
F_{sum} = k_F\sum_{i=1}^4w_i^2 = \frac{m(\ddot z+g)}{c_{\phi}c_{\theta}}
$$

- 计算目标翻滚角 $\phi$ 和俯仰角 $\theta$ 

  根据公式 
  $$
  m\ddot x = k_F\sum_{i=1}^4w_i^2(s_{\phi}s_{\psi}+c_{\phi}s_{\theta}c_{\psi}) \\
  m\ddot y = k_F\sum_{i=1}^4w_i^2(-s_{\phi}c_{\psi}+c_{\phi}s_{\theta}s_{\psi}) \\
  $$
  小角度近似 ( $s_{\phi} \approx \phi,\;s_{\theta} \approx \theta,\;c_{\phi} \approx 1,\;s_{\theta} \approx 1 $ )
  $$
  m\ddot x = F_{sum}({\phi}s_{\psi}+{\theta}c_{\psi}) \\
  m\ddot y = F_{sum}(-{\phi}c_{\psi}+{\theta}s_{\psi}) \\
  $$
  

  逆运算得到（附录1有不用近似的结果）**// todo: 最好用当前的 $\psi$ ?** 

$$
\phi_{des} = \frac{m}{F_{sum}} (\ddot x_{des} \sin\psi_{des} - \ddot y_{des} \cos\psi_{des}) \\
\theta_{des} = \frac{m}{F_{sum}} (\ddot x_{des} \cos\psi_{des} + \ddot y_{des} \sin\psi_{des})
$$

- 姿态环

$$
\begin{bmatrix}  
e_{\phi} \\
e_{\theta} \\
e_{\psi} \\
\end{bmatrix}
=
\begin{bmatrix}  
\phi_{target} \\
\theta_{target} \\
\psi_{target} \\
\end{bmatrix}
-
\begin{bmatrix}  
\phi \\
\theta \\
\psi \\
\end{bmatrix}
$$

$$
\begin{bmatrix}  
\dot\phi_{target} \\
\dot\theta_{target} \\
\dot\psi_{target} \\
\end{bmatrix}
= 
k_p
\begin{bmatrix}  
e_{\phi} \\
e_{\theta} \\
e_{\psi} \\
\end{bmatrix}
+ 
k_i
\int
\begin{bmatrix}  
e_{\phi} \\
e_{\theta} \\
e_{\psi} \\
\end{bmatrix}
dt
+ 
k_d
\frac{d}{dt}
\begin{bmatrix}  
e_{\phi} \\
e_{\theta} \\
e_{\psi} \\
\end{bmatrix}
$$

- 欧拉角到角速度的变换

  根据公式

$$
\begin{bmatrix} w_x \\  w_y \\ w_z \\ \end{bmatrix}
=
\begin{bmatrix} 
1 & 0 & -\sin\theta \\ 
0 & \cos\phi & \sin\phi\cos\theta\\ 
0 & -\sin\phi &  \cos\phi\cos\theta\\ 
\end{bmatrix}
\begin{bmatrix} \dot \phi \\ \dot \theta \\ \dot \psi \\ \end{bmatrix}
$$

​	小角度近似 ( $s_{\phi} \approx 0,\;s_{\theta} \approx 0,\;c_{\phi} \approx 1,\;s_{\theta} \approx 1 $ )	**// todo:看看px4这部分是怎么做的？是否用了小角度近似？**		
$$
\begin{bmatrix} w_{x_{target}} \\  w_{y_{target}} \\ w_{z_{target}} \\ \end{bmatrix}
=
\begin{bmatrix} 
1 & 0 & 0 \\ 
0 & 1 & 0 \\ 
0 & 0 & 1 \\ 

\end{bmatrix}
\begin{bmatrix} \dot \phi_{target} \\ \dot \theta_{target} \\ \dot \psi_{target} \\ \end{bmatrix}
$$

- 角速度环

$$
\begin{bmatrix}  
e_{w_{x}} \\
e_{w_{y}} \\
e_{w_{z}} \\
\end{bmatrix}
=
\begin{bmatrix}  
w_{x_{target}} \\
w_{y_{target}} \\
w_{z_{target}} \\
\end{bmatrix}
-
\begin{bmatrix}  
w_{x} \\
w_{y} \\
w_{z} \\
\end{bmatrix}
$$

$$
\begin{bmatrix}  
\dot w_{x_{target}} \\
\dot w_{y_{target}} \\
\dot w_{z_{target}} \\
\end{bmatrix}
=
k_p
\begin{bmatrix}  
e_{w_{x}} \\
e_{w_{y}} \\
e_{w_{z}} \\
\end{bmatrix}
+
k_i \int
\begin{bmatrix}  
e_{w_{x}} \\
e_{w_{y}} \\
e_{w_{z}} \\
\end{bmatrix}
dt
+
k_d
\frac{d}{dt}
\begin{bmatrix}  
e_{w_{x}} \\
e_{w_{y}} \\
e_{w_{z}} \\
\end{bmatrix}
$$

- 计算力矩

​	根据公式
$$
{}^WM_s = I \cdot\dot {\boldsymbol\omega}  + \boldsymbol\omega \times (I \cdot{\boldsymbol\omega})
$$
​	忽略较小的 $\boldsymbol\omega \times (I \cdot{\boldsymbol\omega})$ 项
$$
\begin{bmatrix}  
\tau_{x_{target}}  \\
\tau_{y_{target}}  \\
\tau_{z_{target}}  \\
\end{bmatrix}
 =
 \begin{bmatrix}  
I_{xx} & 0 & 0 \\
0 & I_{yy} & 0 \\
0 & 0 & I_{zz} \\
\end{bmatrix}
\begin{bmatrix}  
\dot w_{x_{target}} \\
\dot w_{y_{target}} \\
\dot w_{z_{target}} \\
\end{bmatrix}
$$

- 转换

​	根据公式
$$
\begin{bmatrix}  
\tau_{x}  \\
\tau_{y}  \\
\tau_{z}  \\
\end{bmatrix}
=
\begin{bmatrix}  
-\frac{lk_F}{\sqrt2} & \frac{lk_F}{\sqrt2} & \frac{lk_F}{\sqrt2} & -\frac{lk_F}{\sqrt2} \\
 \frac{lk_F}{\sqrt2} & -\frac{lk_F}{\sqrt2} & \frac{lk_F}{\sqrt2} & -\frac{lk_F}{\sqrt2} \\
k_M & k_M & -k_M & -k_M  \\
\end{bmatrix}
\begin{bmatrix}  
w_1^2  \\
w_2^2  \\
w_3^2  \\
w_4^2  \\
\end{bmatrix}
$$

$$
F_{sum} = k_F
\begin{bmatrix}  
w_1^2  \\
w_2^2  \\
w_3^2  \\
w_4^2  \\
\end{bmatrix}
$$

​	得
$$
A = 
\begin{bmatrix}  
-\frac{lk_F}{\sqrt2} & \frac{lk_F}{\sqrt2} & \frac{lk_F}{\sqrt2} & -\frac{lk_F}{\sqrt2} \\
 \frac{lk_F}{\sqrt2} & -\frac{lk_F}{\sqrt2} & \frac{lk_F}{\sqrt2} & -\frac{lk_F}{\sqrt2} \\
k_M & k_M & -k_M & -k_M  \\
k_F & k_F & k_F & k_F  \\
\end{bmatrix}
$$

$$
\begin{bmatrix}  
\tau_{x}  \\
\tau_{y}  \\
\tau_{z}  \\
F_{sum} \\
\end{bmatrix}
=
A
\begin{bmatrix}  
w_1^2  \\
w_2^2  \\
w_3^2  \\
w_4^2  \\
\end{bmatrix}
$$

$$
\begin{bmatrix}  
w_1^2  \\
w_2^2  \\
w_3^2  \\
w_4^2  \\
\end{bmatrix}
=
A^{-1}
\begin{bmatrix}  
\tau_{x}  \\
\tau_{y}  \\
\tau_{z}  \\
F_{sum} \\
\end{bmatrix}
$$

最后计算PWM，将电机转速归一化即可  $\omega\in(0, \omega_{\max})$

**// todo: 在实现时不要直接用代数求逆（数值可能不稳定），而是用线性求解（例如 `w2 = np.linalg.solve(A, b)`）或伪逆（`pinv`）并对解做非负约束**













# 附录：

## 1. 不用小角度近似

$$
m\ddot x = k_F\sum_{i=1}^4w_i^2(s_{\phi}s_{\psi}+c_{\phi}s_{\theta}c_{\psi}) =  F_{sum}(s_{\phi}s_{\psi}+c_{\phi}s_{\theta}c_{\psi}) \\
m\ddot y = k_F\sum_{i=1}^4w_i^2(-s_{\phi}c_{\psi}+c_{\phi}s_{\theta}s_{\psi}) = F_{sum}(-s_{\phi}c_{\psi}+c_{\phi}s_{\theta}s_{\psi}) \\
$$

令 $u = s_{\phi}, \; v = c_{\phi}s_{\theta}$ 
$$
\begin{aligned}  
m
\begin{bmatrix}  
\ddot x \\
\ddot y \\
\end{bmatrix}
&=
F_{sum}
\begin{bmatrix}  
s_{\psi} & c_{\psi} \\
-c_{\psi} & s_{\psi} \\
\end{bmatrix}
\begin{bmatrix}  
u \\
v \\
\end{bmatrix} \\

\end{aligned}
$$
 $\begin{bmatrix}  s_{\psi} & c_{\psi} \\-c_{\psi} & s_{\psi} \\\end{bmatrix}$ 的逆矩阵为
$$
\begin{bmatrix}  
s_{\psi} & -c_{\psi} \\
c_{\psi} & s_{\psi} \\
\end{bmatrix}
$$
解得
$$
\begin{bmatrix}  
u \\
v \\
\end{bmatrix} \\
 = 
 \frac{m}{F_{sum}}\,
 \begin{bmatrix}  
s_{\psi} & -c_{\psi} \\
c_{\psi} & s_{\psi} \\
\end{bmatrix}
\begin{bmatrix}  
\ddot x \\
\ddot y \\
\end{bmatrix}
$$

$$
s_{\phi} = \frac{m}{F_{sum}}(s_{\psi}\ddot x -c_{\psi}\ddot y)\\
c_{\phi}s_{\theta} = \frac{m}{F_{sum}}(c_{\psi}\ddot x + s_{\psi}\ddot y) \\
$$

整理得
$$
\phi_{target} = \arcsin [\frac{m}{F_{sum}}(\ddot x\sin{\psi_{target}} - \ddot y\cos{\psi_{target}})]\\
\theta_{target} = \arcsin \{ [{\frac{m}{F_{sum}} (\ddot x\cos{\psi_{target}} + \ddot y\sin{\psi_{target}})}] \,/\, {\cos{\phi_{target}}} \} \\
$$
其中 $F_{sum} = k_F\sum_{i=1}^4w_i^2$ 
$$

$$





