### 符号定义

$I$：惯性张量

$l$：单臂长度（轴距的一半）

$m$：质量

$k_F$：升力系数

$k_M$：反扭矩系数

${W}$：世界坐标系

${B}$：机体坐标系

${}^WR_B$：机体关于世界坐标系的旋转矩阵

${}^WT_B$：机体关于世界坐标系的位姿变换矩阵

$^B\psi, ^B\theta, ^B\phi$：机体角度

$^Br_x,^Br_y,^Br_z$：机体位置

$^WM_s$：合力矩

$^WF_s$：合力

$^BM_i$：电机 i 产生的反力矩

$^BF_i$：电机 i 产生的推力

$w_i$：电机 i 的角速度

$u_i$：电机 i 的转向，桨叶正装，俯视的情况下，逆时针转等于 -1，顺时针转等于1

电机顺序：1:右前, 2:左后, 3:左前, 4:右后



对于 $t$ 时刻，无人机的位姿为 $r_x,r_y,r_z, \psi, \theta, \phi$ （省略上标$W$）：
$$
{}^WR_B = R_z(\psi)R_y(\theta)R_x(\phi) =  
\begin{bmatrix}  
c_{\psi}c_{\theta} & s_{\phi}s_{\theta}c_{\psi} - s_{\psi}c_{\phi} & s_{\phi}s_{\psi}+s_{\theta}c_{\phi}c_{\psi} \\

s_{\psi}c_{\theta} & s_{\phi}s_{\psi}s_{\theta}+c_{\phi}c_{\psi} & -s_{\phi}c_{\psi}+s_{\psi}s_{\theta}c_{\phi} \\

-s_{\theta} & s_{\phi}c_{\theta} & c_{\phi}c_{\theta}
\end{bmatrix}
\tag{1}
$$
从位移到合力：
$$
^WF_s = 
\begin{bmatrix}  
{}^WF_x  \\
{}^WF_y  \\
{}^WF_z  \\
\end{bmatrix} 
=
m 
\begin{bmatrix}  
\ddot r_x \\
\ddot r_y \\
\ddot r_z \\
\end{bmatrix}

\tag{2}
$$


从 欧拉角速度 $\Theta = \begin{bmatrix} \dot \phi & \dot \theta & \dot \psi \\ \end{bmatrix}^T $ 到机体角速度 $\boldsymbol\omega = \begin{bmatrix} w_x & w_y & w_z \\ \end{bmatrix}^T $ ：（因为欧拉角的角速度的分别的参考坐标系一般不是正交的，所以角速度要变到机体坐标系，即旋转后的坐标系上）
$$
\begin{aligned}  
\begin{bmatrix}  w_x \\  w_y \\  w_z \\ \end{bmatrix}
&=
\begin{bmatrix} \dot \phi \\ 0 \\ 0 \\ \end{bmatrix}
+ 
R_x(\phi)
\begin{bmatrix} 0 \\ \dot \theta \\ 0 \\ \end{bmatrix}
+
R_x(\phi)R_y(\theta)
\begin{bmatrix} 0 \\ 0 \\ \dot \psi \\ \end{bmatrix} \\
\begin{bmatrix} w_x \\  w_y \\ w_z \\ \end{bmatrix}
&=
\begin{bmatrix} 
1 & 0 & -\sin\theta \\ 
0 & \cos\phi & \sin\phi\cos\theta\\ 
0 & -\sin\phi &  \cos\phi\cos\theta\\ 
\end{bmatrix}
\begin{bmatrix} \dot \phi \\ \dot \theta \\ \dot \psi \\ \end{bmatrix}
\end{aligned}
$$
逆变换：
$$
\begin{bmatrix} \dot \phi \\ \dot \theta \\ \dot \psi \\ \end{bmatrix}
=
\begin{bmatrix} 
1 & \sin\phi\tan\theta & \cos\phi\tan\theta \\ 
0 & \cos\phi & -\sin\phi \\ 
0 & \sin\phi/\cos\theta &  \cos\phi/\cos\theta\\ 
\end{bmatrix}
\begin{bmatrix}  w_x \\ w_y \\ w_z \\ \end{bmatrix}
$$
注意：当 $\theta\to \pm 90^\circ(\cos\theta\to0)$ 时，逆变换会失效（万向节死锁 / 奇异），这就是欧拉角的局限。

从机体角度到合力矩： （忽略螺旋桨力矩，只考虑电机力矩）
$$
{}^WM_s = I \cdot\dot {\boldsymbol\omega}  + \boldsymbol\omega \times (I \cdot{\boldsymbol\omega}) \tag3
$$
**注意**：后续在控制的时候，发现不太好控，就暂时把 $\boldsymbol\omega \times (I \cdot{\boldsymbol\omega})$ 去掉了，对结果影响不大。去掉之后得到下式。
$$
\begin{bmatrix}  
\tau_x  \\
\tau_y  \\
\tau_z  \\
\end{bmatrix}
 =
 \begin{bmatrix}  
I_{xx} & 0 & 0 \\
0 & I_{yy} & 0 \\
0 & 0 & I_{zz} \\
\end{bmatrix}
\begin{bmatrix} \dot w_x \\ \dot w_y \\ \dot w_z \\ \end{bmatrix} 
$$


>补充：反对称矩阵
>
>令 $\tilde V_1$ 为 $V_1$ 的反对称矩阵，$ V_1 = \begin{bmatrix} x &y&z \end{bmatrix} $  ，那么
>$$
>\tilde V_1 =
>\begin{bmatrix} 
>0 & -x & y \\
>x & 0 & -z \\
>-y & z & 0 \\
>\end{bmatrix}
>$$
>
>
>有定理
>$$
>V_1 \times V_2 \equiv \tilde V_1V_2
>$$
>

电机推力到合力
$$
{}^WF_s = 
\begin{bmatrix}  
0  \\
0  \\
-mg  \\
\end{bmatrix} +
{}^WR_B
\begin{bmatrix}  
0 \\
0 \\
\sum_{i=1}^4{}^BF_i \\
\end{bmatrix}
$$
电机反扭矩到合力矩 （ $M = r \times F$ ，水平面方向上电机的力不相等造成俯仰和横滚的角速度，竖直方向上由电机的反力矩造成偏航的角速度）
$$
{}^WM_s  = 
 \begin{bmatrix}  
\tau_x  \\
\tau_y  \\
\tau_z  \\
\end{bmatrix} = 
\begin{bmatrix}  
-\frac{lF_1}{\sqrt2} & \frac{lF_2}{\sqrt2} & \frac{lF_3}{\sqrt2} & -\frac{lF_4}{\sqrt2} \\
\frac{lF_1}{\sqrt2} & -\frac{lF_2}{\sqrt2} & \frac{lF_3}{\sqrt2} & -\frac{lF_4}{\sqrt2} \\
^{B}M_1 & ^{B}M_2 & -^{B}M_3 & -^{B}M_4  \\
\end{bmatrix}
$$
单个电机的推力：
$$
F_i = k_F w_i^2
$$
单个电机的反扭矩：
$$
M_i = k_Mw_i^2
$$

---

最终得到无人机的动力学方程为：

- 平动：

$$
m 
\begin{bmatrix}  
\ddot r_x \\
\ddot r_y \\
\ddot r_z \\
\end{bmatrix} =
\begin{bmatrix}  
k_F\sum_{i=1}^4w_i^2(s_{\phi}s_{\psi}+s_{\theta}c_{\phi}c_{\psi}) \\
k_F\sum_{i=1}^4w_i^2(-s_{\phi}c_{\psi}+s_{\psi}s_{\theta}c_{\phi}) \\
k_F\sum_{i=1}^4w_i^2 (c_{\phi}c_{\theta}) -mg \\
\end{bmatrix}
$$

- 转动：

$$
I \cdot\begin{bmatrix} \dot w_x \\ \dot w_y \\ \dot w_z \\ \end{bmatrix}  
=
\begin{bmatrix}  
-\frac{lk_F}{\sqrt2} & \frac{lk_F}{\sqrt2} & \frac{lk_F}{\sqrt2} & -\frac{lk_F}{\sqrt2} \\
 \frac{lk_F}{\sqrt2} & -\frac{lk_F}{\sqrt2} & \frac{lk_F}{\sqrt2} & -\frac{lk_F}{\sqrt2} \\
k_Mu_1 & k_Mu_2 & k_Mu_3 & k_Mu_4  \\
\end{bmatrix}
\begin{bmatrix}  
w_1^2  \\
w_2^2  \\
w_3^2  \\
w_4^2  \\
\end{bmatrix}
$$



